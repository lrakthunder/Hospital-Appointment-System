<div class="doctor-portal">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
    <div class="container-fluid">
      <span class="navbar-brand">
        <img src="/assets/images/logo.png" alt="Hospital Logo" class="logo me-2" onerror="this.style.display='none';">
        Doctor Portal
      </span>
      <div class="d-flex align-items-center text-white">
        <a [routerLink]="['/doctor/profile']" class="text-white text-decoration-none me-3" title="View Profile">
          <i class="bi bi-person-circle"></i> Dr. {{ currentDoctor?.name }}
        </a>
        <button class="btn btn-outline-light btn-sm" (click)="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Dashboard Content -->
  <div class="container-fluid py-3">
    <!-- Stats Cards -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-primary text-white stat-card">
          <div class="card-body text-center py-2 px-2">
            <i class="bi bi-calendar-check" style="font-size: 1.5rem;"></i>
            <h5 class="mt-1 mb-0">{{ stats.total || 0 }}</h5>
            <p class="mb-0" style="font-size: 0.8rem;">Total Appointments</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-warning text-dark stat-card">
          <div class="card-body text-center py-2 px-2">
            <i class="bi bi-hourglass-split" style="font-size: 1.5rem;"></i>
            <h5 class="mt-1 mb-0">{{ stats.pending || 0 }}</h5>
            <p class="mb-0" style="font-size: 0.8rem;">Pending</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-success text-white stat-card">
          <div class="card-body text-center py-2 px-2">
            <i class="bi bi-check-circle" style="font-size: 1.5rem;"></i>
            <h5 class="mt-1 mb-0">{{ stats.confirmed || 0 }}</h5>
            <p class="mb-0" style="font-size: 0.8rem;">Confirmed</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-info text-white stat-card">
          <div class="card-body text-center py-2 px-2">
            <i class="bi bi-check-all" style="font-size: 1.5rem;"></i>
            <h5 class="mt-1 mb-0">{{ stats.completed || 0 }}</h5>
            <p class="mb-0" style="font-size: 0.8rem;">Completed</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's Appointments -->
    <div class="row mb-4" *ngIf="stats.today_appointments && stats.today_appointments.length > 0">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h5 class="mb-0"><i class="bi bi-calendar-day"></i> Today's Appointments</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Appointment Date</th>
                    <th>Patient</th>
                    <th>Contact</th>
                    <th>Department</th>
                    <th>Reason</th>
                    <th>Notes</th>
                    <th>Attachments</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let apt of stats.today_appointments">
                    <td><small>{{ apt.appointment_time | date:'MM-dd-yyyy HH:mm:ss' }}</small></td>
                    <td>
                      <a [routerLink]="['/doctor/patient', apt.user_id]" class="text-primary text-decoration-none">
                        <small>{{ apt.patient_name }}</small>
                      </a>
                    </td>
                    <td><small>{{ apt.patient_email }}<br>{{ apt.patient_phone }}</small></td>
                    <td><small>{{ apt.department }}</small></td>
                    <td><small>{{ apt.reason || 'N/A' }}</small></td>
                    <td>
                      <small class="text-muted note-preview" *ngIf="apt.doctor_notes" (click)="openViewNoteModal(apt)" role="button">
                        <i class="bi bi-sticky"></i> {{ stripHtml(apt.doctor_notes).substring(0, 30) }}{{ stripHtml(apt.doctor_notes).length > 30 ? '...' : '' }}
                        <i class="bi bi-eye ms-1"></i>
                      </small>
                      <small class="text-muted" *ngIf="!apt.doctor_notes">—</small>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" (click)="openAttachmentsModal(apt)">
                        <i class="bi bi-paperclip"></i>
                        <span *ngIf="apt.attachments && apt.attachments.length > 0" class="badge bg-primary ms-1">
                          {{ apt.attachments.length }}
                        </span>
                        <span *ngIf="!apt.attachments || apt.attachments.length === 0">
                          Add
                        </span>
                      </button>
                    </td>
                    <td><span class="badge" [class]="getStatusClass(apt.status)">{{ apt.status }}</span></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-success" *ngIf="apt.status === 'pending'" (click)="confirmAppointment(apt)" title="Confirm">
                          <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-danger" *ngIf="apt.status === 'pending' || apt.status === 'confirmed'" (click)="openDeclineModal(apt)" title="Decline">
                          <i class="bi bi-x"></i>
                        </button>
                        <button class="btn btn-primary" *ngIf="apt.status === 'confirmed'" (click)="completeAppointment(apt)" title="Complete">
                          <i class="bi bi-check-all"></i>
                        </button>
                        <button class="btn btn-outline-secondary" (click)="openNotesModal(apt)" title="Add/View Notes">
                          <i class="bi bi-pencil"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- All Appointments -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> All Appointments</h5>
            <select class="form-select w-auto" [(ngModel)]="statusFilter" (change)="filterByStatus()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="card-body">
            <div *ngIf="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>

            <div *ngIf="!loading && filteredAppointments.length === 0" class="alert alert-info">
              <i class="bi bi-info-circle"></i> No appointments found.
            </div>

            <div class="table-responsive" *ngIf="!loading && filteredAppointments.length > 0">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th class="sortable" (click)="sortBy('appointment_date')">
                      Request Date <i class="bi" [class]="getSortIcon('appointment_date')"></i>
                    </th>
                    <th class="sortable" (click)="sortBy('appointment_time')">
                      Appointment Date <i class="bi" [class]="getSortIcon('appointment_time')"></i>
                    </th>
                    <th class="sortable" (click)="sortBy('patient_name')">
                      Patient <i class="bi" [class]="getSortIcon('patient_name')"></i>
                    </th>
                    <th>Contact</th>
                    <th class="sortable" (click)="sortBy('department')">
                      Department <i class="bi" [class]="getSortIcon('department')"></i>
                    </th>
                    <th>Reason</th>
                    <th>Notes</th>
                    <th>Attachments</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let apt of filteredAppointments">
                    <td><small>{{ apt.appointment_date | date:'MM-dd-yyyy HH:mm:ss' }}</small></td>
                    <td><small>{{ apt.appointment_time | date:'MM-dd-yyyy HH:mm:ss' }}</small></td>
                    <td>
                      <a [routerLink]="['/doctor/patient', apt.user_id]" class="text-primary text-decoration-none">
                        <small>{{ apt.patient_name }}</small>
                      </a>
                    </td>
                    <td><small>{{ apt.patient_email }}<br>{{ apt.patient_phone }}</small></td>
                    <td><small>{{ apt.department }}</small></td>
                    <td><small>{{ apt.reason || 'N/A' }}</small></td>
                    <td>
                      <small class="text-muted note-preview" *ngIf="apt.doctor_notes" (click)="openViewNoteModal(apt)" role="button">
                        <i class="bi bi-sticky"></i> {{ stripHtml(apt.doctor_notes).substring(0, 30) }}{{ stripHtml(apt.doctor_notes).length > 30 ? '...' : '' }}
                        <i class="bi bi-eye ms-1"></i>
                      </small>
                      <small class="text-muted" *ngIf="!apt.doctor_notes">—</small>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" (click)="openAttachmentsModal(apt)">
                        <i class="bi bi-paperclip"></i>
                        <span *ngIf="apt.attachments && apt.attachments.length > 0" class="badge bg-primary ms-1">
                          {{ apt.attachments.length }}
                        </span>
                        <span *ngIf="!apt.attachments || apt.attachments.length === 0">
                          Add
                        </span>
                      </button>
                    </td>
                    <td><span class="badge" [class]="getStatusClass(apt.status)">{{ apt.status }}</span></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-success" *ngIf="apt.status === 'pending'" (click)="confirmAppointment(apt)" title="Confirm">
                          <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-danger" *ngIf="apt.status === 'pending' || apt.status === 'confirmed'" (click)="openDeclineModal(apt)" title="Decline">
                          <i class="bi bi-x"></i>
                        </button>
                        <button class="btn btn-primary" *ngIf="apt.status === 'confirmed'" (click)="completeAppointment(apt)" title="Complete">
                          <i class="bi bi-check-all"></i>
                        </button>
                        <button class="btn btn-outline-secondary" (click)="openNotesModal(apt)" title="Add/View Notes">
                          <i class="bi bi-pencil"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Decline Modal -->
<div class="modal fade" [class.show]="showDeclineModal" [style.display]="showDeclineModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-x-circle"></i> Decline Appointment</h5>
        <button type="button" class="btn-close" (click)="closeDeclineModal()"></button>
      </div>
      <div class="modal-body">
        <p><strong>Patient:</strong> {{ selectedAppointment?.patient_name }}</p>
        <p><strong>Date:</strong> {{ selectedAppointment?.appointment_date }} at {{ selectedAppointment?.appointment_time }}</p>
        <div class="mb-3">
          <label class="form-label">Reason for declining (will be sent to patient via email) *</label>
          <textarea class="form-control" [(ngModel)]="declineReason" rows="4" placeholder="Please provide a reason..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeclineModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDecline()">
          <i class="bi bi-send"></i> Decline & Notify Patient
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showDeclineModal" *ngIf="showDeclineModal"></div>

<!-- Notes Modal -->
<div class="modal fade" [class.show]="showNotesModal" [style.display]="showNotesModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Doctor's Notes</h5>
        <button type="button" class="btn-close" (click)="closeNotesModal()"></button>
      </div>
      <div class="modal-body">
        <p><strong>Patient:</strong> {{ selectedAppointment?.patient_name }}</p>
        <p><strong>Date:</strong> {{ selectedAppointment?.appointment_date }} at {{ selectedAppointment?.appointment_time }}</p>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <div class="NgxEditor__Wrapper">
            <ngx-editor-menu [editor]="editor" [toolbar]="toolbar"></ngx-editor-menu>
            <ngx-editor [editor]="editor" [(ngModel)]="doctorNotes" [placeholder]="'Add your notes here...'"></ngx-editor>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeNotesModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveNotes()">
          <i class="bi bi-save"></i> Save Notes
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showNotesModal" *ngIf="showNotesModal"></div>

<!-- View Note Modal -->
<div class="modal fade" [class.show]="showViewNoteModal" [style.display]="showViewNoteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi" [class.bi-file-text]="!isEditingViewNote" [class.bi-pencil-square]="isEditingViewNote"></i> 
          {{ isEditingViewNote ? 'Edit Note' : 'Doctor\'s Note' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeViewNoteModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3" *ngIf="viewNoteAppointment">
          <small class="text-muted">
            <strong>Patient:</strong> {{ viewNoteAppointment.patient_name }} | 
            <strong>Date:</strong> {{ viewNoteAppointment.appointment_date }}
          </small>
        </div>
        <div class="note-content" *ngIf="!isEditingViewNote">
          <div [innerHTML]="viewingNote || 'No notes available.'" class="view-note-content"></div>
        </div>
        <div *ngIf="isEditingViewNote">
          <div class="NgxEditor__Wrapper">
            <ngx-editor-menu [editor]="editor" [toolbar]="toolbar"></ngx-editor-menu>
            <ngx-editor [editor]="editor" [(ngModel)]="viewingNote" [placeholder]="'Add your notes here...'"></ngx-editor>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeViewNoteModal()">
          <i class="bi bi-x"></i> Close
        </button>
        <button type="button" class="btn btn-warning" (click)="enableEditViewNote()" *ngIf="!isEditingViewNote">
          <i class="bi bi-pencil"></i> Edit Note
        </button>
        <button type="button" class="btn btn-primary" (click)="saveViewNote()" *ngIf="isEditingViewNote">
          <i class="bi bi-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showViewNoteModal" *ngIf="showViewNoteModal"></div>

<!-- Attachments Modal -->
<div class="modal fade" [class.show]="showAttachmentsModal" [style.display]="showAttachmentsModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-paperclip"></i> Appointment Attachments
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeAttachmentsModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3" *ngIf="attachmentAppointment">
          <small class="text-muted">
            <strong>Patient:</strong> {{ attachmentAppointment.patient_name }} | 
            <strong>Date:</strong> {{ attachmentAppointment.appointment_date }}
          </small>
        </div>

        <!-- Existing Attachments -->
        <div class="mb-4" *ngIf="attachmentAppointment && attachmentAppointment.attachments && attachmentAppointment.attachments.length > 0">
          <h6 class="mb-3"><i class="bi bi-files"></i> Existing Files</h6>
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let attachment of attachmentAppointment.attachments">
              <div>
                <i class="bi bi-file-earmark"></i>
                <strong class="ms-2">{{ attachment.file_name }}</strong>
                <small class="text-muted ms-2">({{ formatFileSize(attachment.file_size) }})</small>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" (click)="downloadAttachment(attachmentAppointment!.id, attachment.id, attachment.file_name)" title="Download">
                  <i class="bi bi-download"></i>
                </button>
                <button class="btn btn-outline-danger" (click)="deleteAttachment(attachmentAppointment!.id, attachment.id)" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info" *ngIf="!attachmentAppointment || !attachmentAppointment.attachments || attachmentAppointment.attachments.length === 0">
          <i class="bi bi-info-circle"></i> No attachments yet. Upload files below.
        </div>

        <!-- Upload New Files -->
        <div class="border rounded p-3 bg-light">
          <h6 class="mb-3"><i class="bi bi-cloud-upload"></i> Upload New Files</h6>
          <div class="mb-3">
            <input type="file" class="form-control" (change)="onFilesSelected($event)" multiple accept="*/*">
            <small class="form-text text-muted">Maximum file size: 25MB per file. You can select multiple files.</small>
          </div>

          <!-- Selected Files Preview -->
          <div *ngIf="selectedFiles.length > 0" class="mb-3">
            <h6 class="mb-2">Selected Files:</h6>
            <div class="list-group">
              <div class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let file of selectedFiles; let i = index">
                <div>
                  <i class="bi bi-file-earmark-plus"></i>
                  <strong class="ms-2">{{ file.name }}</strong>
                  <small class="text-muted ms-2">({{ formatFileSize(file.size) }})</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" (click)="removeSelectedFile(i)" title="Remove">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" (click)="uploadFiles()" [disabled]="selectedFiles.length === 0 || uploadingFiles">
            <span *ngIf="!uploadingFiles">
              <i class="bi bi-upload"></i> Upload {{ selectedFiles.length }} File(s)
            </span>
            <span *ngIf="uploadingFiles">
              <span class="spinner-border spinner-border-sm me-2"></span> Uploading...
            </span>
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAttachmentsModal()">
          <i class="bi bi-x"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showAttachmentsModal" *ngIf="showAttachmentsModal"></div>
