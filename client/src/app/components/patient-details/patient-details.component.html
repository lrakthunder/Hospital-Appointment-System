<div class="patient-details-page">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
    <div class="container-fluid">
      <button class="btn btn-outline-light" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </button>
      <span class="navbar-brand ms-3">
        <i class="bi bi-person-fill"></i> Patient Details
      </span>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div *ngIf="!loading && patient">
      <!-- Patient Information Card -->
      <div class="row mb-4">
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-person-badge"></i> Patient Information</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="text-muted small">Name</label>
                <h6>{{ patient.name }}</h6>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Email</label>
                <p class="mb-0"><i class="bi bi-envelope"></i> {{ patient.email }}</p>
              </div>
              <div class="mb-3" *ngIf="patient.phone">
                <label class="text-muted small">Phone</label>
                <p class="mb-0"><i class="bi bi-telephone"></i> {{ patient.phone }}</p>
              </div>
              <div class="mb-3" *ngIf="patient.date_of_birth">
                <label class="text-muted small">Date of Birth</label>
                <p class="mb-0"><i class="bi bi-calendar"></i> {{ patient.date_of_birth }}</p>
              </div>
              <div class="mb-0" *ngIf="patient.address">
                <label class="text-muted small">Address</label>
                <p class="mb-0"><i class="bi bi-geo-alt"></i> {{ patient.address }}</p>
              </div>
            </div>
          </div>

          <!-- Stats Card -->
          <div class="card border-0 shadow-sm mt-3">
            <div class="card-body">
              <div class="row text-center">
                <div class="col-6">
                  <h3 class="text-primary mb-0">{{ totalAppointments }}</h3>
                  <small class="text-muted">Total Visits</small>
                </div>
                <div class="col-6">
                  <h3 class="text-success mb-0">{{ completedAppointments }}</h3>
                  <small class="text-muted">Completed</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Appointment History -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
              <h5 class="mb-0"><i class="bi bi-clock-history"></i> Appointment History</h5>
            </div>
            <div class="card-body">
              <div *ngIf="appointments.length === 0" class="alert alert-info">
                <i class="bi bi-info-circle"></i> No appointment history found.
              </div>

              <div class="table-responsive" *ngIf="appointments.length > 0">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Department</th>
                      <th>Reason</th>
                      <th>Status</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let apt of appointments">
                      <td>{{ apt.appointment_date }}</td>
                      <td>{{ apt.appointment_time }}</td>
                      <td>{{ apt.department }}</td>
                      <td><small>{{ apt.reason || 'N/A' }}</small></td>
                      <td><span class="badge" [class]="getStatusClass(apt.status)">{{ apt.status }}</span></td>
                      <td>
                        <small class="text-muted note-preview" *ngIf="apt.doctor_notes" (click)="openViewNoteModal(apt)" role="button">
                          <i class="bi bi-sticky"></i> {{ stripHtml(apt.doctor_notes).substring(0, 40) }}{{ stripHtml(apt.doctor_notes).length > 40 ? '...' : '' }}
                          <i class="bi bi-eye ms-1"></i>
                        </small>
                        <small class="text-muted" *ngIf="!apt.doctor_notes">â€”</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Note Modal -->
<div class="modal fade" [class.show]="showViewNoteModal" [style.display]="showViewNoteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi" [class.bi-file-text]="!isEditingViewNote" [class.bi-pencil-square]="isEditingViewNote"></i> 
          {{ isEditingViewNote ? 'Edit Note' : 'Doctor\'s Note' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeViewNoteModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3" *ngIf="viewNoteAppointment">
          <small class="text-muted">
            <strong>Date:</strong> {{ viewNoteAppointment.appointment_date }} | 
            <strong>Department:</strong> {{ viewNoteAppointment.department }}
          </small>
        </div>
        <div class="note-content" *ngIf="!isEditingViewNote">
          <div [innerHTML]="viewingNote || 'No notes available.'" class="view-note-content"></div>
        </div>
        <div *ngIf="isEditingViewNote">
          <div class="NgxEditor__Wrapper">
            <ngx-editor-menu [editor]="editor" [toolbar]="toolbar"></ngx-editor-menu>
            <ngx-editor [editor]="editor" [(ngModel)]="viewingNote" [placeholder]="'Add your notes here...'"></ngx-editor>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeViewNoteModal()">
          <i class="bi bi-x"></i> Close
        </button>
        <button type="button" class="btn btn-warning" (click)="enableEditViewNote()" *ngIf="!isEditingViewNote">
          <i class="bi bi-pencil"></i> Edit Note
        </button>
        <button type="button" class="btn btn-primary" (click)="saveViewNote()" *ngIf="isEditingViewNote">
          <i class="bi bi-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showViewNoteModal" *ngIf="showViewNoteModal"></div>

